{{define "inline_form"}}
<div class="inline-form px-4 py-3 border-t border-slate-200 {{if eq .Type "material"}}bg-forest-50{{else if eq .Type "labor"}}bg-copper-50{{else}}bg-slate-100{{end}}" data-item-type="{{.Type}}">
    <form hx-post="/k/categories/{{.CategoryID}}/items"
          hx-target="body"
          class="grid grid-cols-12 gap-2 items-center"
          id="inline-item-form">
        <input type="hidden" name="type" value="{{.Type}}">

        <div class="col-span-5 relative">
            <input type="text"
                   name="name"
                   id="item-name-input"
                   placeholder="Search or enter name..."
                   class="w-full px-2 py-1 border border-slate-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-slate-400 bg-white"
                   autocomplete="off"
                   autofocus
                   required>
            <div id="autocomplete-container"></div>
        </div>

        <input type="number"
               name="quantity"
               id="item-quantity"
               value="1"
               step="0.01"
               min="0.01"
               class="col-span-2 px-2 py-1 border border-slate-300 rounded text-sm text-right focus:outline-none focus:ring-2 focus:ring-slate-400">

        <input type="text"
               name="unit"
               id="item-unit"
               value="{{.DefaultUnit}}"
               placeholder="unit"
               class="col-span-2 px-2 py-1 border border-slate-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-slate-400">

        <div class="col-span-2 flex items-center border border-slate-300 rounded focus-within:ring-2 focus-within:ring-slate-400 overflow-hidden">
            <span class="pl-2 text-slate-500 text-sm shrink-0">$</span>
            <input type="number"
                   name="unit_price"
                   id="item-price"
                   value="0.00"
                   step="0.01"
                   min="0"
                   placeholder="0.00"
                   class="min-w-0 flex-1 px-1 py-1 text-sm text-right focus:outline-none border-0 bg-transparent [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none">
        </div>

        <div class="col-span-1 flex gap-1">
            <button type="submit"
                    class="px-2 py-1 bg-slate-900 text-white rounded text-xs hover:bg-slate-700">
                ↵
            </button>
            <button type="button"
                    onclick="hideInlineForm()"
                    class="px-2 py-1 bg-slate-200 text-slate-700 rounded text-xs hover:bg-slate-300">
                ×
            </button>
        </div>
    </form>
    <p class="text-xs text-slate-500 mt-1">
        <kbd class="px-1 bg-slate-100 rounded">↓</kbd> select suggestion
        <kbd class="px-1 bg-slate-100 rounded ml-2">Tab</kbd> next field
        <kbd class="px-1 bg-slate-100 rounded ml-2">Enter</kbd> save
    </p>
</div>
<script>
(function() {
    const input = document.getElementById('item-name-input');
    const container = document.getElementById('autocomplete-container');
    const form = document.getElementById('inline-item-form');
    const itemType = document.querySelector('[data-item-type]').dataset.itemType;
    let debounceTimer;
    let selectedIndex = -1;

    function getItems() {
        return container.querySelectorAll('.autocomplete-item');
    }

    function updateSelection() {
        const items = getItems();
        items.forEach((item, i) => {
            item.classList.toggle('bg-slate-100', i === selectedIndex);
        });
    }

    function selectItem(item) {
        input.value = item.dataset.name;
        document.getElementById('item-unit').value = item.dataset.unit;
        document.getElementById('item-price').value = item.dataset.price;
        container.innerHTML = '';
        selectedIndex = -1;
        document.getElementById('item-quantity').focus();
        document.getElementById('item-quantity').select();
    }

    function positionDropdown() {
        const rect = input.getBoundingClientRect();
        const dropdown = container.querySelector('.autocomplete-results');
        if (dropdown) {
            dropdown.style.position = 'fixed';
            dropdown.style.top = rect.bottom + 'px';
            dropdown.style.left = rect.left + 'px';
            dropdown.style.width = rect.width + 'px';
        }
    }

    input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();

        if (query.length < 2) {
            container.innerHTML = '';
            return;
        }

        debounceTimer = setTimeout(() => {
            fetch(`/k/items/search?type=${encodeURIComponent(itemType)}&q=${encodeURIComponent(query)}`)
                .then(res => res.text())
                .then(html => {
                    container.innerHTML = html;
                    selectedIndex = -1;
                    positionDropdown();

                    // Add click handlers to results
                    getItems().forEach(item => {
                        item.addEventListener('click', () => selectItem(item));
                    });
                });
        }, 150);
    });

    input.addEventListener('keydown', function(e) {
        const items = getItems();

        if (items.length === 0) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            updateSelection();
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection();
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
            e.preventDefault();
            selectItem(items[selectedIndex]);
        } else if (e.key === 'Escape') {
            container.innerHTML = '';
            selectedIndex = -1;
        }
    });

    // Close autocomplete when clicking outside
    document.addEventListener('click', function(e) {
        if (!container.contains(e.target) && e.target !== input) {
            container.innerHTML = '';
            selectedIndex = -1;
        }
    });
})();
</script>
{{end}}
