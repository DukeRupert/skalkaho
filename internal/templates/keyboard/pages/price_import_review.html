{{define "price_import_review"}}
<!DOCTYPE html>
<html lang="en">
<head>
    {{template "head" .}}
</head>
<body class="bg-slate-50 pb-12">
    {{template "header" .}}

    <main class="max-w-6xl mx-auto p-4">
        <!-- Back link -->
        <a data-back-url="/price-import" class="hidden"></a>

        <!-- Breadcrumb -->
        <nav class="flex items-center gap-2 text-sm text-slate-500 mb-4">
            <a href="/" class="text-copper-700 hover:text-copper-500">Quotes</a>
            <span>/</span>
            <a href="/price-import" class="text-copper-700 hover:text-copper-500">Price Import</a>
            <span>/</span>
            <span class="text-slate-900 font-medium">Review</span>
        </nav>

        <div class="bg-white rounded-lg border border-slate-200 p-6 mb-4">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                <div>
                    <h1 class="text-2xl font-bold tracking-tight text-slate-900">Review Matches</h1>
                    <p class="text-sm text-slate-500 mt-1">{{.Import.Filename}} - {{.Import.TotalRows}} items parsed</p>
                </div>

                {{if eq .Import.Status "ready"}}
                <div class="flex flex-wrap gap-2">
                    <form hx-post="/price-import/{{.Import.ID}}/bulk-approve" hx-target="body">
                        <button type="submit"
                                class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50">
                            Approve All Pending
                        </button>
                    </form>
                    <form hx-post="/price-import/{{.Import.ID}}/apply" hx-target="body">
                        <button type="submit"
                                class="inline-flex items-center rounded-lg bg-copper-700 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-copper-500">
                            Apply {{add (index .StatusCounts "approved") (index .StatusCounts "auto_approved")}} Updates
                        </button>
                    </form>
                </div>
                {{else if eq .Import.Status "applied"}}
                <span class="inline-flex items-center rounded-full bg-forest-100 px-3 py-1 text-sm font-medium text-forest-800">
                    Applied
                </span>
                {{end}}
            </div>

            <!-- Status Summary -->
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
                <div class="bg-forest-50 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-forest-700">{{index .StatusCounts "auto_approved"}}</div>
                    <div class="text-xs text-forest-600">Auto-Approved</div>
                </div>
                <div class="bg-blue-50 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-blue-700">{{index .StatusCounts "approved"}}</div>
                    <div class="text-xs text-blue-600">Approved</div>
                </div>
                <div class="bg-amber-50 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-amber-700">{{index .StatusCounts "pending"}}</div>
                    <div class="text-xs text-amber-600">Pending Review</div>
                </div>
                <div class="bg-slate-100 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-slate-700">{{index .StatusCounts "rejected"}}</div>
                    <div class="text-xs text-slate-600">Rejected</div>
                </div>
            </div>

            <!-- Matches Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead>
                        <tr class="text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                            <th class="px-3 py-3">Source Item</th>
                            <th class="px-3 py-3">Matched Template</th>
                            <th class="px-3 py-3 text-right">New Price</th>
                            <th class="px-3 py-3 text-right">Old Price</th>
                            <th class="px-3 py-3 text-center">Confidence</th>
                            <th class="px-3 py-3">Status</th>
                            <th class="px-3 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {{range .Matches}}
                        <tr id="match-{{.ID}}" class="{{if eq .Status "auto_approved"}}bg-forest-50{{else if eq .Status "approved"}}bg-blue-50{{else if eq .Status "rejected"}}bg-slate-50 opacity-60{{else if ge .Confidence 0.5}}bg-amber-50{{else}}bg-slate-50{{end}}">
                            <td class="px-3 py-3">
                                <div class="font-medium text-slate-900 text-sm">{{.SourceName}}</div>
                                {{if .SourceUnit.Valid}}
                                <div class="text-xs text-slate-500">{{.SourceUnit.String}}</div>
                                {{end}}
                            </td>
                            <td class="px-3 py-3">
                                {{if .TemplateName.Valid}}
                                <div class="font-medium text-slate-900 text-sm">{{.TemplateName.String}}</div>
                                {{if .TemplateUnit.Valid}}
                                <div class="text-xs text-slate-500">{{.TemplateUnit.String}}</div>
                                {{end}}
                                {{else}}
                                <span class="text-sm text-slate-400 italic">No match found</span>
                                {{end}}
                            </td>
                            <td class="px-3 py-3 text-right">
                                <span class="font-mono text-sm text-slate-900">${{printf "%.2f" .SourcePrice}}</span>
                            </td>
                            <td class="px-3 py-3 text-right">
                                {{if .TemplatePrice.Valid}}
                                <span class="font-mono text-sm text-slate-500">${{printf "%.2f" .TemplatePrice.Float64}}</span>
                                {{else}}
                                <span class="text-sm text-slate-400">-</span>
                                {{end}}
                            </td>
                            <td class="px-3 py-3 text-center">
                                <span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium
                                    {{if ge .Confidence 0.9}}bg-forest-100 text-forest-700
                                    {{else if ge .Confidence 0.7}}bg-blue-100 text-blue-700
                                    {{else if ge .Confidence 0.5}}bg-amber-100 text-amber-700
                                    {{else}}bg-slate-100 text-slate-600{{end}}">
                                    {{printf "%.0f" (mul .Confidence 100)}}%
                                </span>
                            </td>
                            <td class="px-3 py-3">
                                <span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium
                                    {{if eq .Status "auto_approved"}}bg-forest-100 text-forest-700
                                    {{else if eq .Status "approved"}}bg-blue-100 text-blue-700
                                    {{else if eq .Status "rejected"}}bg-slate-200 text-slate-600
                                    {{else}}bg-amber-100 text-amber-700{{end}}">
                                    {{if eq .Status "auto_approved"}}Auto
                                    {{else if eq .Status "approved"}}Approved
                                    {{else if eq .Status "rejected"}}Rejected
                                    {{else}}Pending{{end}}
                                </span>
                            </td>
                            <td class="px-3 py-3 text-right">
                                {{if and (eq $.Import.Status "ready") (eq .Status "pending") .MatchedTemplateID.Valid}}
                                <div class="flex items-center justify-end gap-1">
                                    <form hx-put="/price-import/matches/{{.ID}}" hx-target="#match-{{.ID}}" hx-swap="outerHTML">
                                        <input type="hidden" name="status" value="approved">
                                        <button type="submit" class="p-1 text-forest-600 hover:text-forest-800" title="Approve">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                        </button>
                                    </form>
                                    <form hx-put="/price-import/matches/{{.ID}}" hx-target="#match-{{.ID}}" hx-swap="outerHTML">
                                        <input type="hidden" name="status" value="rejected">
                                        <button type="submit" class="p-1 text-red-600 hover:text-red-800" title="Reject">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </form>
                                </div>
                                {{end}}
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>

            {{if not .Matches}}
            <div class="text-center py-8 text-slate-500">
                No matches found. The spreadsheet may not contain recognizable item data.
            </div>
            {{end}}
        </div>
    </main>

    {{template "footer" .}}
</body>
</html>
{{end}}

{{define "shortcuts"}}
<span><kbd class="font-mono text-xs px-1.5 py-0.5 bg-slate-100 border border-slate-300 rounded text-slate-700">esc</kbd> back</span>
{{end}}
